<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kanda — Video.js main + overlay ads (fixed)</title>

  <!-- Video.js CSS -->
  <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />

  <style>
    :root{--max-width:900px}
    body{margin:0;background:#121212;color:#eee;font-family:Arial,Helvetica,sans-serif}
    .page{max-width:var(--max-width);margin:20px auto;padding:12px}
    h1{color:#ff6666;text-align:center;margin-bottom:8px}
    .player-wrap{position:relative;width:100%;max-width:100%;margin:0 auto}
    .player-wrap::after{content:"";display:block;padding-top:56.25%} /* 16:9 */
    .video-js{position:absolute !important;top:0;left:0;width:100% !important;height:100% !important}
    /* pause overlay */
    #pauseOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:12000}
    #pauseSlot{width:80%;height:60%;background:#000;border-radius:8px;overflow:hidden}
    /* sticky */
    #stickyContainer{position:fixed;right:12px;bottom:12px;width:320px;height:180px;background:#000;z-index:20000;box-shadow:0 10px 30px rgba(0,0,0,0.6);border-radius:8px;overflow:hidden;display:none}
    #stickyHeader{height:28px;background:rgba(0,0,0,0.5);color:#fff;display:flex;align-items:center;justify-content:center;font-size:13px}
  </style>
</head>
<body>
  <div class="page">
    <h1>Kanda — Video.js main + overlay ads</h1>

    <div class="player-wrap" id="mainPlayerWrap">
      <!-- main player element (must exist before scripts run) -->
      <video id="mainVideo" class="video-js vjs-default-skin" controls playsinline preload="auto" data-setup='{}'>
        <!-- use HTTPS hosted video to avoid CORS problems -->
        <source src="https://np4248.github.io/videoxx/video3.mp4" type="video/mp4" />
        Your browser does not support HTML5 video.
      </video>
    </div>
  </div>

  <!-- pause overlay (video.js instance will be created inside) -->
  <div id="pauseOverlay"><div id="pauseSlot"></div></div>

  <!-- sticky floating container -->
  <div id="stickyContainer">
    <div id="stickyHeader">Sponsored</div>
    <div id="stickySlot"></div>
  </div>

  <!-- Video.js + contrib-ads + IMA SDK + videojs-ima (correct order) -->
  <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-ads/6.8.0/videojs-contrib-ads.min.js"></script>
  <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ima@1.8.0/dist/videojs.ima.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    (async function(){
      // Defensive wrapper so any runtime error won't break page rendering
      try {
        // ---------- CONFIG ----------
        const VAST_CHAIN = [
          "https://s.magsrv.com/v1/vast.php?idzone=5755632&ex_av=name",
          "https://s.magsrv.com/v1/vast.php?idzone=5757688&ex_av=name",
          "https://s.magsrv.com/v1/vast.php?idzone=5757692&ex_av=name",
          "https://s.magsrv.com/v1/vast.php?idzone=5757698&ex_av=name"
        ];

        const PRIORITY_START = { pre:0, mid:1, post:2, pause:3, sticky:3, seek:3 };

        function rotatedList(roll){
          const start = PRIORITY_START[roll] % VAST_CHAIN.length;
          const out=[];
          for(let i=0;i<VAST_CHAIN.length;i++) out.push(VAST_CHAIN[(start+i)%VAST_CHAIN.length]);
          return out;
        }

        // helper to request ads on a given videojs instance with fallback rotation
        async function requestAdChain(vjsInstance, roll) {
          const tags = rotatedList(roll);
          console.log(`[${roll}] trying tags:`, tags);
          for (let i=0;i<tags.length;i++){
            const tag = tags[i];
            try {
              // set ad tag and request
              vjsInstance.ima.setAdTag(tag);
              vjsInstance.ima.requestAds();
              // wait for outcome: adsready -> startAds, adserror -> fail, adscompleted -> success
              const ok = await new Promise((resolve)=>{
                let done=false;
                function cleanup(){
                  try{ vjsInstance.ima.off('adsready', onReady); }catch(e){}
                  try{ vjsInstance.ima.off('adserror', onError); }catch(e){}
                  try{ vjsInstance.ima.off('adscompleted', onComplete); }catch(e){}
                }
                function onReady(){ try{ vjsInstance.ima.startAds(); }catch(e){} }
                function onError(){ if(done) return; done=true; cleanup(); resolve(false); }
                function onComplete(){ if(done) return; done=true; cleanup(); resolve(true); }
                try {
                  vjsInstance.ima.on('adsready', onReady);
                  vjsInstance.ima.on('adserror', onError);
                  vjsInstance.ima.on('adscompleted', onComplete);
                } catch(e){
                  cleanup(); resolve(false);
                }
                // safety timeout to avoid waiting forever
                setTimeout(()=>{ if(done) return; done=true; cleanup(); resolve(false); }, 12000);
              });
              if (ok) { console.log(`[${roll}] success with tag:`, tag); return true; }
              else { console.warn(`[${roll}] failed tag:`, tag); continue; }
            } catch(err){
              console.warn(`[${roll}] request error for tag ${tag}:`, err);
              continue;
            }
          }
          console.warn(`[${roll}] no tags served`);
          return false;
        }

        // ---------- INIT MAIN VIDEO.JS PLAYER ----------
        const player = videojs('mainVideo');
        // initialize IMA plugin on main player (we'll only use it for pre/mid/post if desired)
        player.ima({ id: 'mainVideo', adLabel: 'Advertisement', debug: true });

        // PRE-ROLL: on first user play
        let preRequested = false;
        player.on('play', async function firstPlayHandler(){
          if (preRequested) return;
          preRequested = true;
          // pause content, run pre-roll on this same instance
          try { player.pause(); } catch(e){}
          await requestAdChain(player, 'pre');
          try { player.play(); } catch(e){}
        });

        // MID-ROLL at 50%: pause, run ads, resume
        let midFired = false;
        player.on('timeupdate', async function(){
          if (midFired) return;
          const d = player.duration();
          if (!d || d === Infinity || isNaN(d)) return;
          const now = player.currentTime();
          if (now >= (d * 0.5) && (d - now) > 5) {
            midFired = true;
            try { player.pause(); } catch(e){}
            await requestAdChain(player, 'mid');
            try { player.play(); } catch(e){}
            // after mid-roll show sticky
            showSticky();
          }
        });

        // POST-ROLL on ended
        player.on('ended', async function(){
          await requestAdChain(player, 'post');
        });

        // ---------- PAUSE OVERLAY (Video.js instance in overlay) ----------
        const pauseOverlay = document.getElementById('pauseOverlay');
        const pauseSlot = document.getElementById('pauseSlot');
        let pauseInner = null; // video.js instance

        player.on('pause', async function(){
          // ignore if ended or if ad currently playing in main
          try {
            const state = player.ima && typeof player.ima.getAdsActive === 'function' ? player.ima.getAdsActive() : false;
            if (player.ended() || state) return;
          } catch(e){ /* ignore */ }

          // show overlay
          pauseOverlay.style.display = 'flex';

          if (!pauseInner) {
            // create a unique video element
            const vid = document.createElement('video');
            const vidId = 'pauseInnerVideo';
            vid.id = vidId;
            vid.className = 'video-js vjs-default-skin';
            vid.setAttribute('playsinline','');
            vid.setAttribute('preload','auto');
            vid.style.width = '100%';
            vid.style.height = '100%';
            pauseSlot.appendChild(vid);

            pauseInner = videojs(vidId, { controls: true, autoplay: false, preload: 'auto' });
            pauseInner.ima({ id: vidId, adLabel: 'Advertisement', debug: true });
          }

          // Try the chain for pause
          const ok = await requestAdChain(pauseInner, 'pause');
          // hide overlay regardless of success, allow user to resume main video
          pauseOverlay.style.display = 'none';
        });

        // when main resumes, ensure overlay is hidden and pause inner pauses
        player.on('play', function(){
          pauseOverlay.style.display = 'none';
          if (pauseInner) try { pauseInner.pause(); } catch(e){}
        });

        // ---------- STICKY MINI-PLAYER ----------
        const stickyContainer = document.getElementById('stickyContainer');
        const stickySlot = document.getElementById('stickySlot');
        let stickyInner = null;

        async function showSticky(){
          // if already visible do nothing
          if (stickyContainer.style.display === 'block') return;
          stickyContainer.style.display = 'block';

          if (!stickyInner) {
            const vid = document.createElement('video');
            const id = 'stickyInnerVideo';
            vid.id = id;
            vid.className = 'video-js vjs-default-skin';
            vid.setAttribute('playsinline','');
            vid.setAttribute('muted','true');
            vid.setAttribute('preload','auto');
            vid.style.width = '100%';
            vid.style.height = '100%';
            stickySlot.appendChild(vid);

            stickyInner = videojs(id, { controls: false, autoplay: true, muted: true, preload: 'auto' });
            stickyInner.ima({ id: id, adLabel: 'Sponsored', debug: true });
          }

          // run the sticky ad chain (muted autoplay)
          await requestAdChain(stickyInner, 'sticky');
        }

        // hide sticky if main player fully in view (optional)
        function checkStickyHideOnView() {
          const rect = document.getElementById('mainPlayerWrap').getBoundingClientRect();
          if (rect.top >= 0 && rect.bottom <= window.innerHeight) {
            if (stickyContainer.style.display === 'block') {
              stickyContainer.style.display = 'none';
              if (stickyInner) { try { stickyInner.pause(); stickyInner.ima && stickyInner.ima.destroy && stickyInner.ima.destroy(); stickyInner.dispose(); } catch(e){} }
              stickyInner = null;
              stickySlot.innerHTML = '';
            }
          }
        }
        window.addEventListener('scroll', throttle(checkStickyHideOnView, 300));

        // ---------- SEEK-ROLL: trigger when user seeks >5s ----------
        let lastTime = 0;
        player.on('timeupdate', function(e){
          const now = player.currentTime();
          if (Math.abs(now - lastTime) > 5) {
            // user performed a seek
            lastTime = now;
            // show a pause overlay ad for seek-roll (reuse pauseInner if present)
            (async ()=>{
              pauseOverlay.style.display = 'flex';
              if (!pauseInner) {
                const vid = document.createElement('video');
                const vidId = 'pauseInnerVideo';
                vid.id = vidId;
                vid.className = 'video-js vjs-default-skin';
                vid.setAttribute('playsinline','');
                vid.setAttribute('preload','auto');
                vid.style.width = '100%';
                vid.style.height = '100%';
                pauseSlot.appendChild(vid);
                pauseInner = videojs(vidId, { controls: true, autoplay: false, preload: 'auto' });
                pauseInner.ima({ id: vidId, adLabel: 'Advertisement', debug: true });
              }
              await requestAdChain(pauseInner, 'seek');
              pauseOverlay.style.display = 'none';
            })();
          }
        });

        // ---------- Utility: throttle ----------
        function throttle(fn, wait) {
          let last = 0;
          return function(...args){
            const now = Date.now();
            if (now - last >= wait) {
              last = now;
              fn.apply(this, args);
            }
          };
        }

        console.log('Setup complete. VAST chain:', VAST_CHAIN);
      } catch (err) {
        // ensure errors don't produce a blank page
        console.error('Overlay ads initialization error (caught):', err);
      }
    })();
  });
  </script>
</body>
</html>
